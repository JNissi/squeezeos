#!/bin/sh

/bin/mount -a

# Create /dev using udev
/etc/init.d/udev start

echo "Mounting RAM Disk"
/bin/mount -t ramfs ramfs /tmp
/bin/mount -t ramfs ramfs /var
mkdir /var/shm /var/log /var/run


# Set hostname
if [ -f /etc/hostname ]; then
	/bin/hostname -F /etc/hostname
fi


# Start syslogd
if [ -e /media/*/log ]; then
	# log and core files to media
	LOG_DIR=/media/*/log

	echo "Starting syslogd (to $LOG_DIR)"
	/sbin/syslogd -s1000 -O $LOG_DIR/messages

	echo "Enabling core files (to $LOG_DIR)"
	echo "$LOG_DIR/core-%e" > /proc/sys/kernel/core_pattern
	ulimit -c unlimited
else
	# log to /var
	echo "Starting syslogd"
	/sbin/syslogd
fi


# Start kernel logger
/sbin/klogd


# Execute firstboot script?
if ! [ -f /etc/firstboot ]; then
	echo "First boot"
	touch /etc/firstboot

	for patch in /media/*/squeezeos.patch; do
		echo "Applying patch: $patch"
		/usr/bin/patch -i $patch
	done

	for script in /media/*/squeezeos-post-reset.sh; do
		if [ -x $script ]; then
			echo "Executing: $script"
			$script
		fi
	done
fi


# Create ssh keys
if ! [ -f /etc/dropbear/dropbear_rsa_host_key ] ; then
	echo "Creating dropbear rsa host key"
	/usr/sbin/dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key
fi

if ! [ -f /etc/dropbear/dropbear_dss_host_key ]; then
	echo "Creating dropbear dss host key"
	/usr/sbin/dropbearkey -t dss -f /etc/dropbear/dropbear_dss_host_key
fi


# Start network
echo "Starting lo"
/sbin/ifconfig lo up 127.0.0.1

echo "Starting inetd"
/usr/sbin/inetd


# Start wlan
/etc/init.d/wlan start


if [ -x /etc/init.d/rcS.local ]; then
	echo "Running rcS.local"
	/etc/init.d/rcS.local
fi

for script in /media/*/squeezeos-boot.sh; do
	if [ -x $script ]; then
		echo "Executing: $script"
		$script
	fi
done


echo "Starting jive applications"
export SDL_NOMOUSE=1
export ALSA_CONFIG_PATH=/usr/share/alsa/alsa.conf
export SQUEEZEPLAY_HOME=/etc/squeezeplay
for dir in /media/*/squeezeplay; do
	if [ -d $dir ]; then
		LUA_PATH="$LUA_PATH;$dir/?.lua"
	fi
done
export LUA_PATH

(cd /usr/bin; /usr/bin/jive &)
