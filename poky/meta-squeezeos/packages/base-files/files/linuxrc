#!/bin/sh
#
# System initialisation

# Mount /proc and /sys filesystems
/bin/mount -a

# Create /dev using mdev
/bin/echo "Creating /dev"
/bin/mount -t ramfs mdev /dev
/bin/mkdir /dev/pts
/bin/mount -t devpts devpts /dev/pts
echo /sbin/mdev > /proc/sys/kernel/hotplug
/sbin/mdev -s

# Mount read/write filesystem
JFFS2_DEV=`grep jffs2 /proc/mtd | cut -c4`
JFFS2_MTD=/dev/mtd/${JFFS2_DEV}
JFFS2_MTDBLOCK=/dev/mtdblock/${JFFS2_DEV}

/bin/mount -t jffs2 -o noatime ${JFFS2_MTDBLOCK} /mnt/storage
JFFS2_OK=$?

# Factory reset
if [ $JFFS2_OK -ne 0 -o -f /mnt/storage/.factoryreset ]
then
	/bin/echo "Factory Reset"

	/bin/umount /mnt/storage
	/usr/sbin/flash_eraseall -q ${JFFS2_MTD}
	/bin/mount -t jffs2 -o noatime ${JFFS2_MTDBLOCK} /mnt/storage
else
	# Upgraded?
	/usr/bin/diff -N /etc/squeezeos.version /mnt/storage/etc/squeezeos.version > /dev/null 2> /dev/null
	if [ $? -ne 0 ]
	then
		# Remove modified files
		/bin/echo "SqueezeOS Upgraded"
		/usr/bin/find /mnt/storage/ -type f | /bin/grep -v -f /etc/keep-after-upgrade | /usr/bin/xargs /bin/rm -f
	fi

	cp /etc/squeezeos.version /mnt/storage/etc/squeezeos.version
fi

# Mount overlay filesystem
/bin/mount -t mini_fo -o base=/,sto=/mnt/storage / /mnt/overlay

# Mount devfs filesystem in overlay
/bin/mount -o move /dev /mnt/overlay/dev

# Run init process
exec /usr/sbin/chroot /mnt/overlay /sbin/init

/bin/echo "Failed to run init"
exec /bin/sh

exit 1

