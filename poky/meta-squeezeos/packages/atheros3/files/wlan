#!/bin/sh

# Get hardware revision (as string)
hwrev=`cat /proc/cpuinfo | grep "Revision" | cut -f2 -d" "`
# Convert to number
hwrev=`expr $hwrev + 0`

echo "wlan: hw rev: $hwrev"

# Load AR6xx3 driver for hw rev >= 9
if [ $hwrev -ge 9 ]
    then
        echo "Using AR6xx3..."
        export WORKAREA=/lib/atheros3
        export EEPROM=${WORKAREA}/calData_WB44-030-D0400_spur_enabled_040312.bin
    else
        echo "Using AR6xx2..."
        export WORKAREA=/lib/atheros
        export EEPROM=${WORKAREA}/calData_ar6102_15dBm.bin
fi

case "$1" in
    start)
        /usr/bin/logger -s "wlan: starting"

	# Set MAC address to the same as Ethernet
	macaddr=`/sbin/ifconfig eth0 | sed -ne 's/.*\(..:..:..:..:..:..\).*/\1/p'`
	if [ "x${macaddr}" != "x" ]
	    then
	    echo "Setting eth1 macaddr: ${macaddr}"
	    SETMAC="--setmac $macaddr"
	fi

	${WORKAREA}/loadAR6000l.sh $SETMAC
	if [ $? -ne 0 ]; then
	    /usr/bin/logger -s "wlan: failed"
	    exit -1
	fi
	sleep 1;

	${WORKAREA}/wmiconfig -i eth1 --filter=all
	sleep 1;

	# Temporary possible work-a-round to fix wireless connectivity issues
	# Disable power save mode
	${WORKAREA}/wmiconfig -i eth1 --power maxperf

	# todo region codes?
	sleep 1;

	# Start wpa_supplicant
	/usr/bin/logger "Starting wpa_supplicant"
	/usr/sbin/wpa_supplicant -B -Dwext -ieth1 -c/etc/wpa_supplicant.conf
	sleep 1;

	/usr/sbin/wpa_cli -B -a/etc/network/wpa_action
	/usr/bin/logger "Started wpa_supplicant"
	sleep 1;

	/usr/bin/logger -s "wlan started"
	;;

    stop)
        /usr/bin/logger -s "wlan: stopping"

	# Stop wpa supplicant
	killall wpa_cli
	killall wpa_supplicant

	# todo Make sure udhcpc is killed
	if [ -r /var/run/udhcpc.eth1.pid ]
	then
	    PID=`cat /var/run/udhcpc.eth1.pid`
	    kill -TERM $PID
	    
	    # Wait until udhcpc is dead
	    kill -0 $PID >/dev/null 2>&1
	    while [ $? == 0 ]; do
	        sleep 1
	        kill -0 $PID >/dev/null 2>&1
	    done
	fi

	# remove wlan driver
	${WORKAREA}/loadAR6000l.sh unloadall

	/usr/bin/logger -s "wlan stopped"
	;;

    *)
	echo "Usage: $0 {start|stop}"
        exit 1
esac

exit 0
