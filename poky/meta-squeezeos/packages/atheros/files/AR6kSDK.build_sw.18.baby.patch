Index: AR6kSDK.build_sw.18/host/localmake.linux.inc
===================================================================
--- AR6kSDK.build_sw.18.orig/host/localmake.linux.inc	2009-04-20 11:52:15.000000000 +0100
+++ AR6kSDK.build_sw.18/host/localmake.linux.inc	2009-04-20 12:57:25.000000000 +0100
@@ -2,7 +2,7 @@
 #  Local Makefile includes for tool and kernel source paths
 #  ***** This is only a sample, modify the paths for your specific build environment *****
 # 
-#  Copyright 2004-2007 Atheros Communications, Inc.
+#  Copyright 2004-2006 Atheros Communications, Inc.
 #
 # When creating a new build type, use the following template:
 #  	ifeq ($(ATH_BUILD_TYPE),<platform name>) 
@@ -11,126 +11,15 @@
 #       ATH_LINUXPATH := < kernel source path >
 #	endif 
 #
+# For a complete list of supported platforms, please refer to the documentation
+# packaged in the release
 #
 
-DEV_BASE :=/usr/dev
 
-ATH_BUILD_TYPE :=LOCAL_FC9_i686
-ATH_BUS_TYPE :=SDIO
-
-ifeq ($(ATH_BUILD_TYPE),LOCAL_FC9_i686)
-
-ATH_LINUXPATH=/lib/modules/2.6.25-14.fc9.i686/build
-
-# SDIO Host Driver
-ifeq ($(ATH_BUS_TYPE), SDIO)
-ATH_HC_DRIVERS :='pci_ellen/ pci_std/'
-endif
-
-endif
-
-ifeq ($(ATH_BUILD_TYPE),LOCAL_i686)
-ATH_LINUXPATH=/lib/modules/2.6.25-14.fc9.i686/build
-
-#ATH_LINUXPATH ?= /trees/etna/root/linux
-
-# SDIO Host Driver
-ifeq ($(ATH_BUS_TYPE), SDIO)
-ATH_HC_DRIVERS :='pci_ellen/ pci_std/'
-endif
-
-endif
-
-ifeq ($(ATH_BUILD_TYPE),OMAP5912) 
-# cross compiling to OMAP 5912
-ATH_ARCH_CPU_TYPE :=arm  
-ATH_CROSS_COMPILE_TYPE :=$(DEV_BASE)/linux/tools/gcc/arm/mv_3.3.1_v4t/bin/arm_v4t_le-
-ATH_LINUXPATH :=$(DEV_BASE)/linux/kernels/mv-omap-5912-linux-2.4.20
-ATH_OS_SUB_TYPE :=linux_2_4
-
-# SDIO Host driver 
-ifeq ($(ATH_BUS_TYPE), SDIO)
-ATH_HC_DRIVERS :=omap/
-endif
-
-# SPI host driver
-ifeq ($(ATH_BUS_TYPE), SPI)
-ATH_HC_DRIVERS :=omap_raw_spi/
-endif
-
-endif
-
-ifeq ($(ATH_BUILD_TYPE),SANDGATEII_ARM) 
-# cross compiling to SandGateII arm
-ATH_ARCH_CPU_TYPE :=arm  
-ATH_CROSS_COMPILE_TYPE :=$(DEV_BASE)/linux/tools/gcc/arm/3.4.3/bin/arm-linux-
-ATH_LINUXPATH :=$(DEV_BASE)/linux/kernels/pxa270-sg2-linux-2.6.9
-
-# SDIO Host Driver
-ifeq ($(ATH_BUS_TYPE), SDIO)
-ATH_HC_DRIVERS :=pxa270/
-endif
-
-endif
-
-ifeq ($(ATH_BUILD_TYPE),SANDGATEII_ARM_MV) 
-# cross compiling to SandGateII arm on MV Linux 2.4.18
-ATH_ARCH_CPU_TYPE :=arm  
-ATH_CROSS_COMPILE_TYPE :=$(DEV_BASE)/linux/tools/gcc/arm/3.4.3/bin/arm-linux-
-ATH_LINUXPATH :=$(DEV_BASE)/linux/kernels/pxa270-sg2-linux-2.4.18
-ATH_OS_SUB_TYPE :=linux_2_4
-
-# SDIO host driver
-ifeq ($(ATH_BUS_TYPE), SDIO)
-ATH_HC_DRIVERS :=pxa270/
-endif
-
-endif
-
-ifeq ($(ATH_BUILD_TYPE),OMAP2420) 
-# cross compiling to OMAP 2420
-ATH_ARCH_CPU_TYPE :=arm  
-ATH_CROSS_COMPILE_TYPE :=$(DEV_BASE)/linux/tools/gcc/arm/mv_3.3.1_v5t/bin/arm_v5t_le-
-ATH_LINUXPATH :=$(DEV_BASE)/linux/kernels/mv-omap-2420-linux-2.4.20
-ATH_OS_SUB_TYPE :=linux_2_4
-
-# SDIO host driver
-ifeq ($(ATH_BUS_TYPE), SDIO)
-ATH_HC_DRIVERS :=omap_2420/
-endif
-
-# SPI-Dragon host driver
-ifeq ($(ATH_BUS_TYPE), SPI)
-ATH_HC_DRIVERS :=omap2420_raw_spi
-endif
-
-# SPI2-Mercury host driver
-ifeq ($(ATH_BUS_TYPE), SPI2)
-ATH_HC_DRIVERS :=omap2420_spi2/
-endif
-
-endif
-
-ifeq ($(ATH_BUILD_TYPE),SGDK020_2)
-ifneq ($(origin KERNEL_SRC),environment)
-ATH_LINUXPATH :=$(DEV_BASE)/linux/kernels/fc3-i686-linux-2.6.9
-else
-ATH_LINUXPATH :=$(KERNEL_SRC)
-endif
-ATH_BUS_TYPE :=MSIO
-endif
-
-ifndef ATH_BUILD_TYPE
-#legacy build
-#set the output path 
-ATH_BUILD_TYPE=LOCAL_i686
-ifneq ($(origin KERNEL_SRC),environment)
-ATH_LINUXPATH :=/trees/etna/root/linux
-else
-ATH_LINUXPATH :=$(KERNEL_SRC)
-endif
-ifneq ($(ATH_BUS_TYPE), CF)
-ATH_BUS_TYPE :=SDIO
-ATH_HC_DRIVERS :='pci_ellen/ pci_std/'
-endif
-endif
+ATH_BUILD_TYPE := NATIVEMMC
+ATH_BUS_TYPE := SDIO
+ATH_BUS_SUBTYPE := linux_sdio
+ATH_LINUXPATH := ${KERNEL_SOURCE}
+ATH_ARCH_CPU_TYPE := arm
+ATH_CROSS_COMPILE_TYPE := ${CROSS_COMPILE}
+ATH_OS_SUB_TYPE := linux_2_6
Index: AR6kSDK.build_sw.18/host/Makefile
===================================================================
--- AR6kSDK.build_sw.18.orig/host/Makefile	2009-04-20 11:52:15.000000000 +0100
+++ AR6kSDK.build_sw.18/host/Makefile	2009-04-20 13:01:56.000000000 +0100
@@ -82,6 +82,7 @@
 export  ATH_SDIO_STACK_BASE
 export  ATH_BUS_TYPE
 export  ATH_HC_DRIVERS
+export  ATH_BUS_SUBTYPE
 
 ATH_SRC_BASE :=$(shell pwd)
 MAKE :=make
@@ -182,8 +183,8 @@
 	$(MAKE) -C tests/floodtest/
 	$(MAKE) -C tests/mboxping/
 #	$(MAKE) -C tests/dsetpatch/
-	$(MAKE) -C 3rdparty/supplicant/opensrc_0_4_9/
-	$(MAKE) -C 3rdparty/pgen/
+#	$(MAKE) -C 3rdparty/supplicant/opensrc_0_4_9/
+#	$(MAKE) -C 3rdparty/pgen/
 #	$(MAKE) -C 3rdparty/WPS/Intel_SDK_1_0_5/linux/	
 #	$(MAKE) -C dwsim/
 ifeq ($(ATH_BUILD_BTFILTER),yes) 	
@@ -232,13 +233,13 @@
 	fi	
 endif	
 	cp -f tools/dbgParser/dbgParser $(COMPILED_IMAGE_OBJECTS_PATH)
-	cp -f 3rdparty/supplicant/opensrc_0_4_9/wpa_supplicant  $(COMPILED_IMAGE_OBJECTS_PATH)
-	cp -f 3rdparty/supplicant/opensrc_0_4_9/wpa_cli  $(COMPILED_IMAGE_OBJECTS_PATH)	
-	cp -f 3rdparty/pgen/pgen  $(COMPILED_IMAGE_OBJECTS_PATH)	
-	cp -f 3rdparty/pgen/pget  $(COMPILED_IMAGE_OBJECTS_PATH)	
-	cp -f 3rdparty/pgen/phone  $(COMPILED_IMAGE_OBJECTS_PATH)	
-	cp -f 3rdparty/pgen/staut  $(COMPILED_IMAGE_OBJECTS_PATH)	
-	cp -f 3rdparty/pgen/upsd  $(COMPILED_IMAGE_OBJECTS_PATH)	
+#	cp -f 3rdparty/supplicant/opensrc_0_4_9/wpa_supplicant  $(COMPILED_IMAGE_OBJECTS_PATH)
+#	cp -f 3rdparty/supplicant/opensrc_0_4_9/wpa_cli  $(COMPILED_IMAGE_OBJECTS_PATH)
+#	cp -f 3rdparty/pgen/pgen  $(COMPILED_IMAGE_OBJECTS_PATH)
+#	cp -f 3rdparty/pgen/pget  $(COMPILED_IMAGE_OBJECTS_PATH)
+#	cp -f 3rdparty/pgen/phone  $(COMPILED_IMAGE_OBJECTS_PATH)
+#	cp -f 3rdparty/pgen/staut  $(COMPILED_IMAGE_OBJECTS_PATH)
+#	cp -f 3rdparty/pgen/upsd  $(COMPILED_IMAGE_OBJECTS_PATH)
 #	cp -f 3rdparty/WPS/Intel_SDK_1_0_5/linux/wsccmd  $(COMPILED_IMAGE_OBJECTS_PATH)			
 #	cp -f 3rdparty/WPS/Intel_SDK_1_0_5/linux/wsc_config.txt  $(COMPILED_IMAGE_OBJECTS_PATH)				
 #	if [ -r  $(ATH_SRC_BASE)/3rdparty/supplicant/ds/linux/bin/$(ATH_BUILD_TYPE) ]; then \
@@ -261,8 +262,7 @@
 	tools/rompatcher/rompatcher tools/rompatcher/fwpatch tests/floodtest/floodtest            \
 	tests/mboxping/mboxping tools/wmiconfig/wmiconfig tools/mkdsetimg/mkdsetimg               \
 	tools/eeprom/eeprom dwsim/*.o dwsim/dwsim tools/eeprom/eeprom.AR6001                      \
-	tools/eeprom/eeprom.AR6002 3rdparty/supplicant/opensrc_0_4_9/*.d                          \
-	tools/athbtfilter/bluez/abtfilt
+	tools/eeprom/eeprom.AR6002 tools/athbtfilter/bluez/abtfilt
 
 # The kernel module build process leaves some intermediate files, this will clean up all these files
 	find $(ATH_SRC_BASE) \( -not -path "*.output*" -a -name '*.[oas]' -o -name core -o -name '.*.flags' -o -name '.ko' -o -name '.*.cmd' \) -type f -print \
Index: AR6kSDK.build_sw.18/host/os/linux/wireless_ext.c
===================================================================
--- AR6kSDK.build_sw.18.orig/host/os/linux/wireless_ext.c	2009-04-20 11:50:54.000000000 +0100
+++ AR6kSDK.build_sw.18/host/os/linux/wireless_ext.c	2009-04-20 12:57:25.000000000 +0100
@@ -59,7 +59,7 @@
 {
     struct iw_event iwe;
 #if WIRELESS_EXT > 14
-    char buf[256];
+    static char buf[8192];
 #endif
     struct ar_giwscan_param *param;
     A_CHAR *current_ev;
Index: AR6kSDK.build_sw.18/host/wlan/src/wlan_node.c
===================================================================
--- AR6kSDK.build_sw.18.orig/host/wlan/src/wlan_node.c	2009-04-20 11:51:31.000000000 +0100
+++ AR6kSDK.build_sw.18/host/wlan/src/wlan_node.c	2009-04-20 12:57:25.000000000 +0100
@@ -216,8 +216,22 @@
 static void
 wlan_node_dec_free(bss_t *ni)
 {
+	if (ni == NULL) {
+		printk(KERN_INFO "wlan_node_dec_free NULL\n");
+	} else {
+		if (ni->ni_buf == NULL) {
+			printk(KERN_INFO "ni_buf == NULL\n");
+		}
+	}
     if (ieee80211_node_dectestref(ni)) {
-        wlan_node_free(ni);
+	    if (ni == NULL) {
+		    printk(KERN_INFO "2:wlan_node_dec_free NULL\n");
+	    } else {
+		    if (ni->ni_buf == NULL) {
+			    printk(KERN_INFO "2:ni_buf == NULL\n");
+		    }
+	    }
+	    wlan_node_free(ni);
     }
 }
 
