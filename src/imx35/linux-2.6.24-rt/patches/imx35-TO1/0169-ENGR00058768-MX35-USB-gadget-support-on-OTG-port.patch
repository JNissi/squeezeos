From 5c48bf3afbb9aaa6bd085ff8b498b579f057d4bc Mon Sep 17 00:00:00 2001
From: Jun Li <r65092@freescale.com>
Date: Sun, 18 May 2008 16:35:51 +0800
Subject: [PATCH] ENGR00058768 MX35 USB gadget support on OTG port

Required to support USB-OTG drivers in MX35 platform

Signed-off-by: Jun Li <r65092@freescale.com>
---
 arch/arm/plat-mxc/usb_common.c  |   32 ++++++++++++++++++--------------
 drivers/usb/gadget/arcotg_udc.c |    2 ++
 drivers/usb/gadget/arcotg_udc.h |    6 ++++--
 3 files changed, 24 insertions(+), 16 deletions(-)

diff --git a/arch/arm/plat-mxc/usb_common.c b/arch/arm/plat-mxc/usb_common.c
index 2079864..5480f4c 100644
--- a/arch/arm/plat-mxc/usb_common.c
+++ b/arch/arm/plat-mxc/usb_common.c
@@ -342,22 +342,22 @@ static void usbh2_set_serial_xcvr(void)
 	UH2_USBCMD |= UCMD_RESET;
 	while (UH2_USBCMD & UCMD_RESET);
 
-	USBCTRL &= ~(UCTRL_H2SIC_MASK); /* Disable bypass mode */
+	USBCTRL &= ~(UCTRL_H2SIC_MASK);	/* Disable bypass mode */
 	USBCTRL &= ~(UCTRL_H2PM);	/* Power Mask */
-	USBCTRL |= UCTRL_H2WIE |        /* Wakeup intr enable */
-	UCTRL_IP_PUE_DOWN |		/* ipp_pue_pulldwn_dpdm */
-	UCTRL_USBTE |			/* USBT is enabled */
-	UCTRL_H2DT;			/* Disable H2 TLL */
+	USBCTRL |= UCTRL_H2WIE |	/* Wakeup intr enable */
+	    UCTRL_IP_PUE_DOWN |	/* ipp_pue_pulldwn_dpdm */
+	    UCTRL_USBTE |	/* USBT is enabled */
+	    UCTRL_H2DT;		/* Disable H2 TLL */
 
 	USBCTRL &= ~(UCTRL_PP);
-	UH2_PORTSC1 = (UH2_PORTSC1&(~PORTSC_PTS_MASK)) | PORTSC_PTS_SERIAL;
+	UH2_PORTSC1 = (UH2_PORTSC1 & (~PORTSC_PTS_MASK)) | PORTSC_PTS_SERIAL;
 
 	if (UH2_HCSPARAMS & HCSPARAMS_PPC)
 		UH2_PORTSC1 |= PORTSC_PORT_POWER;
 
 	/* Reset controller before set host mode */
 	UH2_USBCMD |= UCMD_RESET;
-	while (UH2_USBCMD & UCMD_RESET);
+	while (UH2_USBCMD & UCMD_RESET) ;
 
 	msleep(100);
 }
@@ -582,13 +582,13 @@ static void otg_set_utmi_xcvr(void)
 	while (UOG_USBCMD & UCMD_RUN_STOP);
 
 	UOG_USBCMD |= UCMD_RESET;
-	while ((UOG_USBCMD)&(UCMD_RESET));
+	while ((UOG_USBCMD) & (UCMD_RESET));
 
-	USBCTRL &= ~UCTRL_OCE;        /* Disable OverCurrent signal */
-	USBCTRL &= ~UCTRL_PP;         /* USBOTG_PWR low active */
-	USBCTRL &= ~UCTRL_OCPOL;      /* OverCurrent Polarity is Low Active */
-	USBCTRL &= ~UCTRL_OPM;        /* OTG Power Mask */
-	USBCTRL |= UCTRL_OWIE; 	      /* ULPI intr enable */
+	USBCTRL &= ~UCTRL_OCE;	/* Disable OverCurrent signal */
+	USBCTRL &= ~UCTRL_PP;	/* USBOTG_PWR low active */
+	USBCTRL &= ~UCTRL_OCPOL;	/* OverCurrent Polarity is Low Active */
+	USBCTRL &= ~UCTRL_OPM;	/* OTG Power Mask */
+	USBCTRL |= UCTRL_OWIE;	/* ULPI intr enable */
 
 	/* set UTMI xcvr */
 	tmp = UOG_PORTSC1 & ~PORTSC_PTS_MASK;
@@ -604,8 +604,12 @@ static void otg_set_utmi_xcvr(void)
 	/* need to reset the controller here so that the ID pin
 	 * is correctly detected.
 	 */
+	/* Stop then Reset */
+	UOG_USBCMD &= ~UCMD_RUN_STOP;
+	while (UOG_USBCMD & UCMD_RUN_STOP);
+
 	UOG_USBCMD |= UCMD_RESET;
-	while ((UOG_USBCMD)&(UCMD_RESET));
+	while ((UOG_USBCMD) & (UCMD_RESET));
 
 	/* allow controller to reset, and leave time for
 	 * the ULPI transceiver to reset too.
diff --git a/drivers/usb/gadget/arcotg_udc.c b/drivers/usb/gadget/arcotg_udc.c
index 1fe7a62..70613ee 100644
--- a/drivers/usb/gadget/arcotg_udc.c
+++ b/drivers/usb/gadget/arcotg_udc.c
@@ -346,6 +346,8 @@ static int dr_controller_setup(struct arcotg_udc *udc)
 
 	usb_slave_regs->portsc1 = cpu_to_le32(portctrl);
 
+	/* AHB burst INCR mode */
+	usb_slave_regs->sbuscfg = (usb_slave_regs->sbuscfg & (~0x07));
 	fsl_platform_set_vbus_power(pdata, 0);
 
 	return 0;
diff --git a/drivers/usb/gadget/arcotg_udc.h b/drivers/usb/gadget/arcotg_udc.h
index fad3430..3479816 100644
--- a/drivers/usb/gadget/arcotg_udc.h
+++ b/drivers/usb/gadget/arcotg_udc.h
@@ -1,5 +1,5 @@
 /*
- * Copyright 2004-2007 Freescale Semiconductor, Inc. All Rights Reserved.
+ * Copyright 2004-2008 Freescale Semiconductor, Inc. All Rights Reserved.
  */
 
 /*
@@ -35,7 +35,9 @@
 struct usb_dr_device {
 	/* Capability register */
 	u32 id;
-	u32 res1[63];
+	u32 res1[35];
+	u32 sbuscfg;		/* sbuscfg ahb burst */
+	u32 res11[27];
 	u16 caplength;		/* Capability Register Length */
 	u16 hciversion;		/* Host Controller Interface Version */
 	u32 hcsparams;		/* Host Controller Structual Parameters */
-- 
1.5.4.4

