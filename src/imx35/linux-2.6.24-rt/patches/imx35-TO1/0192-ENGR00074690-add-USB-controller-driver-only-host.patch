From 93f4d5c82806bf557ae3d98adde3cf3c2ac6f67c Mon Sep 17 00:00:00 2001
From: Albert Chen <R65187@freescale.com>
Date: Mon, 2 Jun 2008 13:41:15 +0800
Subject: [PATCH] ENGR00074690 : add USB controller driver, only host mode,

Add power operation in utmixc.
Mx37: USB host driver

Signed-off-by: Albert Chen <r65187@freescale.com>
---
 arch/arm/configs/imx37_3stack_defconfig      |  170 ++++++++++++++++++++++++-
 arch/arm/mach-mx37/mx37_3stack_pmic_wm8350.c |    8 ++
 arch/arm/mach-mx37/usb.c                     |   49 +++++++-
 arch/arm/plat-mxc/Kconfig                    |    2 +-
 arch/arm/plat-mxc/usb_common.c               |   12 +-
 arch/arm/plat-mxc/utmixc.c                   |   28 ++++
 6 files changed, 253 insertions(+), 16 deletions(-)

diff --git a/arch/arm/configs/imx37_3stack_defconfig b/arch/arm/configs/imx37_3stack_defconfig
index 3443c8b..63e39fd 100644
--- a/arch/arm/configs/imx37_3stack_defconfig
+++ b/arch/arm/configs/imx37_3stack_defconfig
@@ -1,7 +1,7 @@
 #
 # Automatically generated make config: don't edit
 # Linux kernel version: 2.6.24
-# Mon May 19 17:24:16 2008
+# Wed May 28 15:52:17 2008
 #
 CONFIG_ARM=y
 CONFIG_SYS_SUPPORTS_APM_EMULATION=y
@@ -184,6 +184,8 @@ CONFIG_ARCH_MXC_HAS_NFC_V3_1=y
 CONFIG_MXC_TZIC=y
 CONFIG_ARCH_HAS_EVTMON=y
 CONFIG_DMA_ZONE_SIZE=24
+CONFIG_INTERN_UTMI=y
+# CONFIG_ISP1504_MXC is not set
 
 #
 # Processor Type
@@ -462,6 +464,7 @@ CONFIG_MTD_NAND_MXC_V3=y
 # CONFIG_MTD_NAND_MXC_FORCE_CE is not set
 # CONFIG_MXC_NAND_LOW_LEVEL_ERASE is not set
 # CONFIG_MTD_NAND_PLATFORM is not set
+# CONFIG_MTD_ALAUDA is not set
 # CONFIG_MTD_ONENAND is not set
 
 #
@@ -491,6 +494,7 @@ CONFIG_BLK_DEV=y
 CONFIG_BLK_DEV_LOOP=y
 # CONFIG_BLK_DEV_CRYPTOLOOP is not set
 # CONFIG_BLK_DEV_NBD is not set
+# CONFIG_BLK_DEV_UB is not set
 # CONFIG_BLK_DEV_RAM is not set
 # CONFIG_CDROM_PKTCDVD is not set
 # CONFIG_ATA_OVER_ETH is not set
@@ -513,9 +517,10 @@ CONFIG_SCSI_PROC_FS=y
 CONFIG_BLK_DEV_SD=y
 # CONFIG_CHR_DEV_ST is not set
 # CONFIG_CHR_DEV_OSST is not set
-# CONFIG_BLK_DEV_SR is not set
-# CONFIG_CHR_DEV_SG is not set
-# CONFIG_CHR_DEV_SCH is not set
+CONFIG_BLK_DEV_SR=y
+# CONFIG_BLK_DEV_SR_VENDOR is not set
+CONFIG_CHR_DEV_SG=y
+CONFIG_CHR_DEV_SCH=y
 
 #
 # Some SCSI devices (e.g. CD jukebox) support multiple LUNs
@@ -602,6 +607,25 @@ CONFIG_NET_PCI=y
 #
 # CONFIG_WLAN_PRE80211 is not set
 # CONFIG_WLAN_80211 is not set
+
+#
+# USB Network Adapters
+#
+# CONFIG_USB_CATC is not set
+# CONFIG_USB_KAWETH is not set
+# CONFIG_USB_PEGASUS is not set
+# CONFIG_USB_RTL8150 is not set
+CONFIG_USB_USBNET=m
+# CONFIG_USB_NET_AX8817X is not set
+CONFIG_USB_NET_CDCETHER=m
+# CONFIG_USB_NET_DM9601 is not set
+# CONFIG_USB_NET_GL620A is not set
+# CONFIG_USB_NET_NET1080 is not set
+# CONFIG_USB_NET_PLUSB is not set
+# CONFIG_USB_NET_MCS7830 is not set
+# CONFIG_USB_NET_RNDIS_HOST is not set
+# CONFIG_USB_NET_CDC_SUBSET is not set
+# CONFIG_USB_NET_ZAURUS is not set
 # CONFIG_WAN is not set
 CONFIG_PPP=m
 # CONFIG_PPP_MULTILINK is not set
@@ -729,6 +753,7 @@ CONFIG_I2C_MXC=y
 # CONFIG_I2C_SIMTEC is not set
 # CONFIG_I2C_TAOS_EVM is not set
 # CONFIG_I2C_STUB is not set
+# CONFIG_I2C_TINY_USB is not set
 # CONFIG_I2C_PCA_ISA is not set
 
 #
@@ -747,6 +772,7 @@ CONFIG_I2C_MXC=y
 # CONFIG_I2C_DEBUG_ALGO is not set
 # CONFIG_I2C_DEBUG_BUS is not set
 # CONFIG_I2C_DEBUG_CHIP is not set
+# CONFIG_I2C_SLAVE is not set
 
 #
 # SPI support
@@ -790,6 +816,11 @@ CONFIG_MXC_WATCHDOG=y
 # CONFIG_WDT is not set
 
 #
+# USB-based Watchdog Cards
+#
+# CONFIG_USBPCWATCHDOG is not set
+
+#
 # Sonics Silicon Backplane
 #
 CONFIG_SSB_POSSIBLE=y
@@ -863,6 +894,13 @@ CONFIG_VIDEO_MXC_IPU_OUTPUT=y
 # CONFIG_VIDEO_MXC_OPL is not set
 # CONFIG_VIDEO_SAA5246A is not set
 # CONFIG_VIDEO_SAA5249 is not set
+CONFIG_V4L_USB_DRIVERS=y
+# CONFIG_VIDEO_PVRUSB2 is not set
+# CONFIG_VIDEO_USBVISION is not set
+# CONFIG_USB_ET61X251 is not set
+# CONFIG_USB_SN9C102 is not set
+# CONFIG_USB_ZC0301 is not set
+# CONFIG_USB_ZR364XX is not set
 # CONFIG_RADIO_ADAPTERS is not set
 # CONFIG_DVB_CORE is not set
 # CONFIG_DAB is not set
@@ -982,6 +1020,12 @@ CONFIG_SND_MXC_SPDIF=m
 #
 
 #
+# USB devices
+#
+# CONFIG_SND_USB_AUDIO is not set
+# CONFIG_SND_USB_CAIAQ is not set
+
+#
 # System on Chip audio support
 #
 CONFIG_SND_SOC=y
@@ -1002,20 +1046,132 @@ CONFIG_SND_SOC_WM8350=y
 #
 # CONFIG_SOUND_PRIME is not set
 CONFIG_HID_SUPPORT=y
-CONFIG_HID=m
+CONFIG_HID=y
 # CONFIG_HID_DEBUG is not set
 # CONFIG_HIDRAW is not set
+
+#
+# USB Input Devices
+#
+CONFIG_USB_HID=m
+# CONFIG_USB_HIDINPUT_POWERBOOK is not set
+# CONFIG_HID_FF is not set
+# CONFIG_USB_HIDDEV is not set
+
+#
+# USB HID Boot Protocol drivers
+#
+# CONFIG_USB_KBD is not set
+# CONFIG_USB_MOUSE is not set
 CONFIG_USB_SUPPORT=y
 CONFIG_USB_ARCH_HAS_HCD=y
 # CONFIG_USB_ARCH_HAS_OHCI is not set
-# CONFIG_USB_ARCH_HAS_EHCI is not set
-# CONFIG_USB is not set
+CONFIG_USB_ARCH_HAS_EHCI=y
+CONFIG_USB=y
+# CONFIG_USB_DEBUG is not set
+
+#
+# Miscellaneous USB options
+#
+CONFIG_USB_DEVICEFS=y
+# CONFIG_USB_DEVICE_CLASS is not set
+# CONFIG_USB_DYNAMIC_MINORS is not set
+# CONFIG_USB_SUSPEND is not set
+# CONFIG_USB_PERSIST is not set
+# CONFIG_USB_OTG is not set
+
+#
+# USB Host Controller Drivers
+#
+CONFIG_USB_EHCI_HCD=m
+CONFIG_USB_EHCI_ARC=y
+CONFIG_USB_EHCI_ARC_OTG=y
+CONFIG_USB_EHCI_ARC_OTGHS=y
+# CONFIG_USB_EHCI_ARC_OTGFS is not set
+# CONFIG_USB_EHCI_SPLIT_ISO is not set
+CONFIG_USB_EHCI_ROOT_HUB_TT=y
+# CONFIG_USB_EHCI_TT_NEWSCHED is not set
+# CONFIG_USB_ISP116X_HCD is not set
+# CONFIG_USB_SL811_HCD is not set
+# CONFIG_USB_R8A66597_HCD is not set
+
+#
+# USB Device Class drivers
+#
+# CONFIG_USB_ACM is not set
+# CONFIG_USB_PRINTER is not set
 
 #
 # NOTE: USB_STORAGE enables SCSI, and 'SCSI disk support'
 #
 
 #
+# may also be needed; see USB_STORAGE Help for more information
+#
+CONFIG_USB_STORAGE=y
+# CONFIG_USB_STORAGE_DEBUG is not set
+# CONFIG_USB_STORAGE_DATAFAB is not set
+# CONFIG_USB_STORAGE_FREECOM is not set
+# CONFIG_USB_STORAGE_ISD200 is not set
+# CONFIG_USB_STORAGE_DPCM is not set
+# CONFIG_USB_STORAGE_USBAT is not set
+# CONFIG_USB_STORAGE_SDDR09 is not set
+# CONFIG_USB_STORAGE_SDDR55 is not set
+# CONFIG_USB_STORAGE_JUMPSHOT is not set
+# CONFIG_USB_STORAGE_ALAUDA is not set
+# CONFIG_USB_STORAGE_KARMA is not set
+# CONFIG_USB_LIBUSUAL is not set
+
+#
+# USB Imaging devices
+#
+# CONFIG_USB_MDC800 is not set
+# CONFIG_USB_MICROTEK is not set
+# CONFIG_USB_MON is not set
+
+#
+# Belcarra USBLAN Networking for USB
+#
+# CONFIG_USB_USBLAN is not set
+
+#
+# USB port drivers
+#
+
+#
+# USB Serial Converter support
+#
+# CONFIG_USB_SERIAL is not set
+
+#
+# USB Miscellaneous drivers
+#
+# CONFIG_USB_EMI62 is not set
+# CONFIG_USB_EMI26 is not set
+# CONFIG_USB_ADUTUX is not set
+# CONFIG_USB_AUERSWALD is not set
+# CONFIG_USB_RIO500 is not set
+# CONFIG_USB_LEGOTOWER is not set
+# CONFIG_USB_LCD is not set
+# CONFIG_USB_BERRY_CHARGE is not set
+# CONFIG_USB_LED is not set
+# CONFIG_USB_CYPRESS_CY7C63 is not set
+# CONFIG_USB_CYTHERM is not set
+# CONFIG_USB_PHIDGET is not set
+# CONFIG_USB_IDMOUSE is not set
+# CONFIG_USB_FTDI_ELAN is not set
+# CONFIG_USB_APPLEDISPLAY is not set
+# CONFIG_USB_SISUSBVGA is not set
+# CONFIG_USB_LD is not set
+# CONFIG_USB_TRANCEVIBRATOR is not set
+# CONFIG_USB_IOWARRIOR is not set
+# CONFIG_USB_TEST is not set
+
+#
+# USB DSL modem support
+#
+
+#
 # USB Gadget Support
 #
 # CONFIG_USB_GADGET is not set
diff --git a/arch/arm/mach-mx37/mx37_3stack_pmic_wm8350.c b/arch/arm/mach-mx37/mx37_3stack_pmic_wm8350.c
index ce5ed6d..2b568ce 100644
--- a/arch/arm/mach-mx37/mx37_3stack_pmic_wm8350.c
+++ b/arch/arm/mach-mx37/mx37_3stack_pmic_wm8350.c
@@ -293,6 +293,14 @@ int wm8350_init(struct wm8350 *wm8350)
 		wm8350_gpio_set_status(wm8350, 7, 1);
 	else
 		printk(KERN_ERR "Error in setting Wolfson GPIO pin 7 \n");
+	/* enable gpio4:USB_VBUS_EN */
+	ret =
+	    wm8350_gpio_config(wm8350, 4, WM8350_GPIO_DIR_IN,
+			       WM8350_GPIO4_MR_IN, WM8350_GPIO_ACTIVE_HIGH,
+			       WM8350_GPIO_PULL_UP, WM8350_GPIO_INVERT_OFF,
+			       WM8350_GPIO_DEBOUNCE_OFF);
+	if (ret)
+		printk(KERN_ERR "Error in setting USB VBUS enable pin\n");
 
 	/* register sound */
 	printk("Registering imx37_snd_device");
diff --git a/arch/arm/mach-mx37/usb.c b/arch/arm/mach-mx37/usb.c
index 907c576..c1df167 100644
--- a/arch/arm/mach-mx37/usb.c
+++ b/arch/arm/mach-mx37/usb.c
@@ -46,12 +46,21 @@
 #include <asm/mach-types.h>
 #include <asm/arch/arc_otg.h>
 
+extern struct platform_device *host_pdev_register(struct resource *res,
+						  int n_res,
+						  struct fsl_usb2_platform_data
+						  *config);
+
 extern int usbotg_init(struct platform_device *pdev);
 extern void usbotg_uninit(struct fsl_usb2_platform_data *pdata);
 extern int gpio_usbotg_hs_active(void);
 extern void gpio_usbotg_hs_inactive(void);
 
 #if defined(CONFIG_USB_EHCI_ARC_OTG) || defined(CONFIG_USB_GADGET_ARC)
+
+static int usbotg_init_ext(struct platform_device *pdev);
+static void usbotg_uninit_ext(struct fsl_usb2_platform_data *pdata);
+
 static struct resource otg_resources[] = {
 	{
 	 .start = (u32) (OTG_BASE_ADDR),
@@ -63,11 +72,24 @@ static struct resource otg_resources[] = {
 	 .flags = IORESOURCE_IRQ,
 	 },
 };
+static struct fsl_usb2_platform_data mxc_utmi_host_config = {
+	.name = "OTG",
+	.platform_init = usbotg_init_ext,
+	.platform_uninit = usbotg_uninit_ext,
+	.usbmode = (u32) &UOG_USBMODE,
+	.viewport = (u32) &UOG_ULPIVIEW,
+	.does_otg = 0,
+	.operating_mode = FSL_USB2_DR_HOST,
+	.power_budget = 150,	/* 150 mA max power */
+	.gpio_usb_active = gpio_usbotg_hs_active,
+	.gpio_usb_inactive = gpio_usbotg_hs_inactive,
+	.transceiver = "utmi",
+};
 
-/* Notes: configure USB clock*/
 static int usbotg_init_ext(struct platform_device *pdev)
 {
 	struct clk *usb_clk;
+	struct fsl_usb2_platform_data *pdata;
 
 	usb_clk = clk_get(NULL, "usboh2_clk");
 	clk_enable(usb_clk);
@@ -82,8 +104,27 @@ static int usbotg_init_ext(struct platform_device *pdev)
 	clk_disable(usb_clk);
 	clk_put(usb_clk);
 
+	pdata = (struct fsl_usb2_platform_data *)pdev->dev.platform_data;
+	pdata->viewport = (u32) pdev;
 	return usbotg_init(pdev);
 }
+
+static void usbotg_uninit_ext(struct fsl_usb2_platform_data *pdata)
+{
+	struct clk *usb_clk;
+
+	usb_clk = clk_get(NULL, "usboh2_clk");
+	clk_disable(usb_clk);
+	clk_put(usb_clk);
+
+	usb_clk = clk_get(NULL, "usb_phy_clk");
+	clk_disable(usb_clk);
+	clk_put(usb_clk);
+
+	usbotg_uninit(pdata);
+}
+
+
 #endif
 
 #if defined(CONFIG_USB_GADGET_ARC)
@@ -100,7 +141,7 @@ static u64 udc_dmamask = ~(u32) 0;
 static struct fsl_usb2_platform_data mxc_utmi_peripheral_config = {
 	.name = "OTG",
 	.platform_init = usbotg_init_ext,
-	.platform_uninit = usbotg_uninit,
+	.platform_uninit = usbotg_uninit_ext,
 	.usbmode = (u32) &UOG_USBMODE,
 	.does_otg = 0,
 	.operating_mode = FSL_USB2_DR_DEVICE,
@@ -135,6 +176,10 @@ static int __init mx37_usb_init(void)
 		pr_debug("usb: OTG Gadget registered\n");
 	}
 #endif
+#ifdef CONFIG_USB_EHCI_ARC_OTG
+	host_pdev_register(otg_resources, ARRAY_SIZE(otg_resources),
+			   &mxc_utmi_host_config);
+#endif
 
 	return 0;
 }
diff --git a/arch/arm/plat-mxc/Kconfig b/arch/arm/plat-mxc/Kconfig
index b7b012b..c39ff32 100644
--- a/arch/arm/plat-mxc/Kconfig
+++ b/arch/arm/plat-mxc/Kconfig
@@ -17,7 +17,7 @@ config ARCH_MX37
     bool "MX37-based"
 	select CPU_V6
 	select CACHE_L2X0
-	#select USB_ARCH_HAS_EHCI
+	select USB_ARCH_HAS_EHCI
 	select ARCH_HAS_EVTMON
 	select MXC_TZIC
     help
diff --git a/arch/arm/plat-mxc/usb_common.c b/arch/arm/plat-mxc/usb_common.c
index 8c93bf0..7b80583 100644
--- a/arch/arm/plat-mxc/usb_common.c
+++ b/arch/arm/plat-mxc/usb_common.c
@@ -337,10 +337,10 @@ static void usbh2_set_serial_xcvr(void)
 
 	/* Stop then Reset */
 	UH2_USBCMD &= ~UCMD_RUN_STOP;
-	while (UH2_USBCMD & UCMD_RUN_STOP);
+	while (UH2_USBCMD & UCMD_RUN_STOP) ;
 
 	UH2_USBCMD |= UCMD_RESET;
-	while (UH2_USBCMD & UCMD_RESET);
+	while (UH2_USBCMD & UCMD_RESET) ;
 
 	USBCTRL &= ~(UCTRL_H2SIC_MASK);	/* Disable bypass mode */
 	USBCTRL &= ~(UCTRL_H2PM);	/* Power Mask */
@@ -579,10 +579,10 @@ static void otg_set_utmi_xcvr(void)
 
 	/* Stop then Reset */
 	UOG_USBCMD &= ~UCMD_RUN_STOP;
-	while (UOG_USBCMD & UCMD_RUN_STOP);
+	while (UOG_USBCMD & UCMD_RUN_STOP) ;
 
 	UOG_USBCMD |= UCMD_RESET;
-	while ((UOG_USBCMD) & (UCMD_RESET));
+	while ((UOG_USBCMD) & (UCMD_RESET)) ;
 
 	USBCTRL &= ~UCTRL_OCE;	/* Disable OverCurrent signal */
 	USBCTRL &= ~UCTRL_PP;	/* USBOTG_PWR low active */
@@ -606,10 +606,10 @@ static void otg_set_utmi_xcvr(void)
 	 */
 	/* Stop then Reset */
 	UOG_USBCMD &= ~UCMD_RUN_STOP;
-	while (UOG_USBCMD & UCMD_RUN_STOP);
+	while (UOG_USBCMD & UCMD_RUN_STOP) ;
 
 	UOG_USBCMD |= UCMD_RESET;
-	while ((UOG_USBCMD) & (UCMD_RESET));
+	while ((UOG_USBCMD) & (UCMD_RESET)) ;
 
 	/* allow controller to reset, and leave time for
 	 * the ULPI transceiver to reset too.
diff --git a/arch/arm/plat-mxc/utmixc.c b/arch/arm/plat-mxc/utmixc.c
index 58024c3..0b78eff 100644
--- a/arch/arm/plat-mxc/utmixc.c
+++ b/arch/arm/plat-mxc/utmixc.c
@@ -22,6 +22,7 @@
 
 #include <asm/hardware.h>
 #include <asm/arch/arc_otg.h>
+#include <asm/mach-types.h>
 
 static void usb_utmi_init(struct fsl_xcvr_ops *this)
 {
@@ -31,11 +32,38 @@ static void usb_utmi_uninit(struct fsl_xcvr_ops *this)
 {
 }
 
+/*!
+ * set vbus power
+ *
+ * @param       view  viewport register
+ * @param       on    power on or off
+ */
+static void set_power(u32 *view, int on)
+{
+	struct device *dev;
+	struct platform_device *pdev;
+	struct regulator *usbotg_regux;
+
+	pr_debug("real %s(on=%d) view=0x%p\n", __FUNCTION__, on, view);
+	if (machine_is_mx37_3ds()) {
+		pdev = (struct platform_device *)view;
+		dev = &(pdev->dev);
+		usbotg_regux = regulator_get(dev, "DCDC2");
+		if (on) {
+			regulator_enable(usbotg_regux);
+		} else {
+			regulator_disable(usbotg_regux);
+		}
+		regulator_put(usbotg_regux, dev);
+	}
+}
+
 static struct fsl_xcvr_ops utmi_ops = {
 	.name = "utmi",
 	.xcvr_type = PORTSC_PTS_UTMI,
 	.init = usb_utmi_init,
 	.uninit = usb_utmi_uninit,
+	.set_vbus_power = set_power,
 };
 
 extern void fsl_usb_xcvr_register(struct fsl_xcvr_ops *xcvr_ops);
-- 
1.5.4.4

