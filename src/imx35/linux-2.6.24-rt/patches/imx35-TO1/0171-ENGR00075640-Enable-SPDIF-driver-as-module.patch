From c594885cfa26de47c28d18201c4a88af69281782 Mon Sep 17 00:00:00 2001
From: Wallace Wang <r59996@freescale.com>
Date: Sun, 18 May 2008 16:41:33 +0800
Subject: [PATCH] ENGR00075640 Enable SPDIF driver as module

To support multiple sound cards
Use index parameter to register sound card

Signed-off-by: Wallace Wang <r59996@freescale.com>
---
 arch/arm/configs/imx35_3stack_defconfig |    2 +-
 arch/arm/configs/imx37_3stack_defconfig |    2 +-
 sound/arm/Makefile                      |    3 ++-
 sound/arm/mxc-alsa-spdif.c              |   22 +++++++++++++++++++---
 4 files changed, 23 insertions(+), 6 deletions(-)

diff --git a/arch/arm/configs/imx35_3stack_defconfig b/arch/arm/configs/imx35_3stack_defconfig
index c4ee020..2ac4e66 100644
--- a/arch/arm/configs/imx35_3stack_defconfig
+++ b/arch/arm/configs/imx35_3stack_defconfig
@@ -982,7 +982,7 @@ CONFIG_SND_VERBOSE_PROCFS=y
 #
 # ALSA ARM devices
 #
-# CONFIG_SND_MXC_SPDIF is not set
+CONFIG_SND_MXC_SPDIF=m
 
 #
 # SPI devices
diff --git a/arch/arm/configs/imx37_3stack_defconfig b/arch/arm/configs/imx37_3stack_defconfig
index 9404c15..57c8f5e 100644
--- a/arch/arm/configs/imx37_3stack_defconfig
+++ b/arch/arm/configs/imx37_3stack_defconfig
@@ -957,7 +957,7 @@ CONFIG_SND_VERBOSE_PROCFS=y
 #
 # ALSA ARM devices
 #
-# CONFIG_SND_MXC_SPDIF is not set
+CONFIG_SND_MXC_SPDIF=m
 
 #
 # SPI devices
diff --git a/sound/arm/Makefile b/sound/arm/Makefile
index e666aa5..4f56862 100644
--- a/sound/arm/Makefile
+++ b/sound/arm/Makefile
@@ -22,4 +22,5 @@ obj-$(CONFIG_SND_MXC_PMIC)	+= snd-mxc-alsa.o
 snd-mxc-alsa-objs		:= mxc-alsa-pmic.o mxc-alsa-mixer.o
 
 CFLGS_mxc_alsa_spdif.o = -I$(TOPDIR)/drivers/mxc
-obj-$(CONFIG_SND_MXC_SPDIF)	+= mxc-alsa-spdif.o
+obj-$(CONFIG_SND_MXC_SPDIF)    += snd-spdif.o
+snd-spdif-objs                 := mxc-alsa-spdif.o
diff --git a/sound/arm/mxc-alsa-spdif.c b/sound/arm/mxc-alsa-spdif.c
index c2283f1..4ac69f8 100644
--- a/sound/arm/mxc-alsa-spdif.c
+++ b/sound/arm/mxc-alsa-spdif.c
@@ -54,6 +54,15 @@
 #include <sound/control.h>
 
 #define MXC_SPDIF_NAME "MXC_SPDIF"
+static int index[SNDRV_CARDS] = SNDRV_DEFAULT_IDX;
+static char *id[SNDRV_CARDS] = SNDRV_DEFAULT_STR;
+static int enable[SNDRV_CARDS] = SNDRV_DEFAULT_ENABLE;
+module_param_array(index, int, NULL, 0444);
+MODULE_PARM_DESC(index, "Index value for spdif sound card.");
+module_param_array(id, charp, NULL, 0444);
+MODULE_PARM_DESC(id, "ID string for spdif sound card.");
+module_param_array(enable, bool, NULL, 0444);
+MODULE_PARM_DESC(enable, "Enable spdif sound card.");
 
 #define SPDIF_MAX_BUF_SIZE      (32*1024)
 #define SPDIF_DMA_BUF_SIZE	(8*1024)
@@ -2057,6 +2066,7 @@ static int mxc_alsa_spdif_probe(struct platform_device
 				*pdev)
 {
 	int err, idx;
+	static int dev;
 	struct snd_card *card;
 	struct mxc_spdif_device *chip;
 	struct resource *res;
@@ -2067,8 +2077,15 @@ static int mxc_alsa_spdif_probe(struct platform_device
 	if (!res)
 		return -ENOENT;
 
+	if (dev >= SNDRV_CARDS)
+		return -ENODEV;
+	if (!enable[dev]) {
+		dev++;
+		return -ENOENT;
+	}
+
 	/* register the soundcard */
-	card = snd_card_new(SNDRV_DEFAULT_IDX1, "MXC SPDIF", THIS_MODULE,
+	card = snd_card_new(index[dev], id[dev], THIS_MODULE,
 			    sizeof(struct mxc_spdif_device));
 	if (card == NULL)
 		return -ENOMEM;
@@ -2118,8 +2135,7 @@ static int mxc_alsa_spdif_probe(struct platform_device
 	/* disable all the interrupts */
 	spdif_intr_enable(0xffffff, 0);
 	/* spdif interrupt register and disable */
-	if (request_irq(MXC_INT_SPDIF, spdif_isr, 0, "spdif",
-			chip->card->dev)) {
+	if (request_irq(MXC_INT_SPDIF, spdif_isr, 0, "spdif", chip->card->dev)) {
 		pr_err("MXC spdif: failed to request irq\n");
 		err = -EBUSY;
 		goto nodev;
-- 
1.5.4.4

