From c953f959e6b67d7be163aa11c3ec4c2eac134d5f Mon Sep 17 00:00:00 2001
From: Robby Cai <r63905@freescale.com>
Date: Tue, 4 Mar 2008 11:30:39 +0800
Subject: [PATCH] ENGR00047811 Add VPU driver support for MX37

Add VPU driver support for MX37

Signed-off-by: Robby Cai <r63905@freescale.com>
---
 arch/arm/configs/imx37_3stack_defconfig |    3 +++
 arch/arm/mach-mx37/devices.c            |   22 ++++++++++++++++++++++
 drivers/mxc/vpu/Kconfig                 |    5 +++--
 3 files changed, 28 insertions(+), 2 deletions(-)

diff --git a/arch/arm/configs/imx37_3stack_defconfig b/arch/arm/configs/imx37_3stack_defconfig
index 41cecbe..4bea3b2 100644
--- a/arch/arm/configs/imx37_3stack_defconfig
+++ b/arch/arm/configs/imx37_3stack_defconfig
@@ -1,6 +1,7 @@
 #
 # Automatically generated make config: don't edit
 # Linux kernel version: 2.6.24
+# Mon Feb 25 13:31:49 2008
 #
 CONFIG_ARM=y
 CONFIG_SYS_SUPPORTS_APM_EMULATION=y
@@ -918,6 +919,8 @@ CONFIG_RTC_LIB=y
 #
 # MXC VPU(Video Processing Unit) support
 #
+CONFIG_MXC_VPU=y
+# CONFIG_MXC_VPU_DEBUG is not set
 
 #
 # File systems
diff --git a/arch/arm/mach-mx37/devices.c b/arch/arm/mach-mx37/devices.c
index ca8dd1c..80a3660 100644
--- a/arch/arm/mach-mx37/devices.c
+++ b/arch/arm/mach-mx37/devices.c
@@ -491,6 +491,27 @@ struct mxc_gpio_port mxc_gpio_ports[GPIO_PORT_NUM] = {
 	 },
 };
 
+#if defined(CONFIG_MXC_VPU) || defined(CONFIG_MXC_VPU_MODULE)
+/*! Platform Data for MXC VPU */
+static struct platform_device mxcvpu_device = {
+	.name = "mxc_vpu",
+	.id = 0,
+	.dev = {
+		.release = mxc_nop_release,
+		},
+};
+
+static inline void mxc_init_vpu(void)
+{
+	if (platform_device_register(&mxcvpu_device) < 0)
+		printk(KERN_ERR "Error: Registering the VPU.\n");
+}
+#else
+static inline void mxc_init_vpu(void)
+{
+}
+#endif
+
 static struct platform_device mxc_dma_device = {
 	.name = "mxc_dma",
 	.id = 0,
@@ -514,6 +535,7 @@ static int __init mxc_init_devices(void)
 	mxc_init_owire();
 	mxc_init_scc();
 	mxc_init_dma();
+	mxc_init_vpu();
 
 	/* SPBA configuration for SSI2 - SDMA and MCU are set */
 	spba_take_ownership(SPBA_SSI2, SPBA_MASTER_C | SPBA_MASTER_A);
diff --git a/drivers/mxc/vpu/Kconfig b/drivers/mxc/vpu/Kconfig
index d05c543..7c73a52 100644
--- a/drivers/mxc/vpu/Kconfig
+++ b/drivers/mxc/vpu/Kconfig
@@ -6,10 +6,11 @@ menu "MXC VPU(Video Processing Unit) support"
 
 config MXC_VPU
 	  tristate "Support for MXC VPU(Video Processing Unit)"
-	  depends on (ARCH_MX3 || ARCH_MX27 || ARCH_MXC92323)
+	  depends on (ARCH_MX3 || ARCH_MX27 || ARCH_MXC92323 || ARCH_MX37)
 	  default y
 	---help---
-	  The VPU codec device provides codec function for H.264/MPEG4/H.263
+	  The VPU codec device provides codec function for H.264/MPEG4/H.263,
+	  as well as MPEG2/VC-1/DivX on some platforms.
 
 config MXC_VPU_DEBUG
 	bool "MXC VPU debugging"
-- 
1.5.4.4

