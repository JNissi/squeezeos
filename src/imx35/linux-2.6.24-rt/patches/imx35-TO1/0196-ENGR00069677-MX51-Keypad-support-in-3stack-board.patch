From 55bc5cd5d0060fe893ad692b9eb4b1abca2a56c7 Mon Sep 17 00:00:00 2001
From: Sam Yang <r52096@freescale.com>
Date: Wed, 4 Jun 2008 17:37:07 +0800
Subject: [PATCH] ENGR00069677 MX51 Keypad support in 3stack board

Support keypad in MX51 3stack board.

Signed-off-by: Sam Yang <r52096@freescale.com>
---
 arch/arm/configs/imx51_3stack_defconfig |   21 ++++++++++---
 arch/arm/mach-mx51/mx51_3stack.c        |   49 +++++++++++++++++++++++++++++++
 arch/arm/mach-mx51/mx51_3stack_gpio.c   |   34 +++++++++++++++++++++
 3 files changed, 99 insertions(+), 5 deletions(-)

diff --git a/arch/arm/configs/imx51_3stack_defconfig b/arch/arm/configs/imx51_3stack_defconfig
index 289745d..64d5bdf 100644
--- a/arch/arm/configs/imx51_3stack_defconfig
+++ b/arch/arm/configs/imx51_3stack_defconfig
@@ -1,6 +1,7 @@
 #
 # Automatically generated make config: don't edit
 # Linux kernel version: 2.6.24
+# Wed Jun  4 17:05:53 2008
 #
 CONFIG_ARM=y
 CONFIG_SYS_SUPPORTS_APM_EMULATION=y
@@ -162,7 +163,6 @@ CONFIG_ARCH_MX51=y
 # CONFIG_ARCH_MX21 is not set
 CONFIG_MXC_SDMA_API=y
 # CONFIG_SDMA_IRAM is not set
-# CONFIG_ARCH_MXC_HAS_NFC_V3 is not set
 
 #
 # MX51 Options
@@ -177,7 +177,6 @@ CONFIG_MACH_MX51_3STACK=y
 # Device options
 #
 CONFIG_MXC_TZIC=y
-CONFIG_ARCH_HAS_EVTMON=y
 CONFIG_DMA_ZONE_SIZE=24
 
 #
@@ -599,20 +598,27 @@ CONFIG_SLHC=m
 #
 CONFIG_INPUT=y
 # CONFIG_INPUT_FF_MEMLESS is not set
-# CONFIG_INPUT_POLLDEV is not set
+CONFIG_INPUT_POLLDEV=y
 
 #
 # Userland interfaces
 #
 # CONFIG_INPUT_MOUSEDEV is not set
 # CONFIG_INPUT_JOYDEV is not set
-# CONFIG_INPUT_EVDEV is not set
+CONFIG_INPUT_EVDEV=y
 # CONFIG_INPUT_EVBUG is not set
 
 #
 # Input Device Drivers
 #
-# CONFIG_INPUT_KEYBOARD is not set
+CONFIG_INPUT_KEYBOARD=y
+# CONFIG_KEYBOARD_ATKBD is not set
+# CONFIG_KEYBOARD_SUNKBD is not set
+# CONFIG_KEYBOARD_LKKBD is not set
+# CONFIG_KEYBOARD_XTKBD is not set
+# CONFIG_KEYBOARD_NEWTON is not set
+# CONFIG_KEYBOARD_STOWAWAY is not set
+CONFIG_KEYBOARD_MXC=y
 # CONFIG_INPUT_MOUSE is not set
 # CONFIG_INPUT_JOYSTICK is not set
 # CONFIG_INPUT_TABLET is not set
@@ -660,6 +666,7 @@ CONFIG_HW_RANDOM=y
 # CONFIG_TCG_TPM is not set
 CONFIG_DEVPORT=y
 # CONFIG_I2C is not set
+# CONFIG_I2C_SLAVE is not set
 
 #
 # SPI support
@@ -794,6 +801,10 @@ CONFIG_RTC_LIB=y
 #
 
 #
+# MXC Asynchronous Sample Rate Converter support
+#
+
+#
 # File systems
 #
 CONFIG_EXT2_FS=y
diff --git a/arch/arm/mach-mx51/mx51_3stack.c b/arch/arm/mach-mx51/mx51_3stack.c
index 2623c1c..545de57 100644
--- a/arch/arm/mach-mx51/mx51_3stack.c
+++ b/arch/arm/mach-mx51/mx51_3stack.c
@@ -16,6 +16,7 @@
 #include <linux/delay.h>
 #include <linux/interrupt.h>
 #include <linux/irq.h>
+#include <asm/mach/keypad.h>
 #include <linux/init.h>
 #include <linux/input.h>
 #include <linux/nodemask.h>
@@ -75,6 +76,53 @@ void board_ref_clk_rate(unsigned long *ckil, unsigned long *osc,
 	*ckih2 = 24576000;
 }
 
+#if defined(CONFIG_KEYBOARD_MXC) || defined(CONFIG_KEYBOARD_MXC_MODULE)
+static u16 keymapping[24] = {
+	KEY_1, KEY_2, KEY_3, KEY_F1, KEY_UP, KEY_F2,
+	KEY_4, KEY_5, KEY_6, KEY_LEFT, KEY_SELECT, KEY_RIGHT,
+	KEY_7, KEY_8, KEY_9, KEY_F3, KEY_DOWN, KEY_F4,
+	KEY_0, KEY_OK, KEY_ESC, KEY_ENTER, KEY_MENU, KEY_BACK,
+};
+
+static struct resource mxc_kpp_resources[] = {
+	[0] = {
+	       .start = MXC_INT_KPP,
+	       .end = MXC_INT_KPP,
+	       .flags = IORESOURCE_IRQ,
+	       }
+};
+
+static struct keypad_data keypad_plat_data = {
+	.rowmax = 4,
+	.colmax = 6,
+	.irq = MXC_INT_KPP,
+	.learning = 0,
+	.delay = 2,
+	.matrix = keymapping,
+};
+
+/* mxc keypad driver */
+static struct platform_device mxc_keypad_device = {
+	.name = "mxc_keypad",
+	.id = 0,
+	.num_resources = ARRAY_SIZE(mxc_kpp_resources),
+	.resource = mxc_kpp_resources,
+	.dev = {
+		.release = mxc_nop_release,
+		.platform_data = &keypad_plat_data,
+		},
+};
+
+static void mxc_init_keypad(void)
+{
+	(void)platform_device_register(&mxc_keypad_device);
+}
+#else
+static inline void mxc_init_keypad(void)
+{
+}
+#endif
+
 #if defined(CONFIG_FB_MXC_SYNC_PANEL) || \
 	defined(CONFIG_FB_MXC_SYNC_PANEL_MODULE)
 static struct platform_device mxc_fb_device[] = {
@@ -331,6 +379,7 @@ static void __init mxc_board_init(void)
 	mxc_expio_init();
 	mxc_init_enet();
 	mxc_init_fb();
+	mxc_init_keypad();
 }
 
 /*
diff --git a/arch/arm/mach-mx51/mx51_3stack_gpio.c b/arch/arm/mach-mx51/mx51_3stack_gpio.c
index 346805b..9ecb59c 100644
--- a/arch/arm/mach-mx51/mx51_3stack_gpio.c
+++ b/arch/arm/mach-mx51/mx51_3stack_gpio.c
@@ -277,6 +277,19 @@ EXPORT_SYMBOL(gpio_ata_inactive);
  */
 void gpio_keypad_active(void)
 {
+	/*
+	 * Configure the IOMUX control register for keypad signals.
+	 */
+	mxc_request_iomux(MX51_PIN_KEY_COL0, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_COL1, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_COL2, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_COL3, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_COL4, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_COL5, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_ROW0, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_ROW1, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_ROW2, IOMUX_CONFIG_ALT0);
+	mxc_request_iomux(MX51_PIN_KEY_ROW3, IOMUX_CONFIG_ALT0);
 }
 EXPORT_SYMBOL(gpio_keypad_active);
 
@@ -286,6 +299,27 @@ EXPORT_SYMBOL(gpio_keypad_active);
  */
 void gpio_keypad_inactive(void)
 {
+	mxc_request_gpio(MX51_PIN_KEY_COL0);
+	mxc_request_gpio(MX51_PIN_KEY_COL1);
+	mxc_request_gpio(MX51_PIN_KEY_COL2);
+	mxc_request_gpio(MX51_PIN_KEY_COL3);
+	mxc_request_gpio(MX51_PIN_KEY_COL4);
+	mxc_request_gpio(MX51_PIN_KEY_COL5);
+	mxc_request_gpio(MX51_PIN_KEY_ROW0);
+	mxc_request_gpio(MX51_PIN_KEY_ROW1);
+	mxc_request_gpio(MX51_PIN_KEY_ROW2);
+	mxc_request_gpio(MX51_PIN_KEY_ROW3);
+
+	mxc_free_iomux(MX51_PIN_KEY_COL0, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_COL1, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_COL2, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_COL3, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_COL4, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_COL5, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_ROW0, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_ROW1, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_ROW2, IOMUX_CONFIG_GPIO);
+	mxc_free_iomux(MX51_PIN_KEY_ROW3, IOMUX_CONFIG_GPIO);
 }
 EXPORT_SYMBOL(gpio_keypad_inactive);
 
-- 
1.5.4.4

