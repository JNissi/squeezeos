From cb25ff2efaf843cb946caeb3ef5c512f53600a58 Mon Sep 17 00:00:00 2001
From: Wallace Wang <r59996@freescale.com>
Date: Wed, 16 Jul 2008 11:34:29 +0800
Subject: [PATCH] ENGR00083357 Stop/restart of audio stream causes audio noise

Stop/restart will disturb the period sequence

Signed-off-by: Wallace Wang <r59996@freescale.com>
---
 sound/soc/imx/imx-pcm.c |   34 ++--------------------------------
 1 files changed, 2 insertions(+), 32 deletions(-)

diff --git a/sound/soc/imx/imx-pcm.c b/sound/soc/imx/imx-pcm.c
index 02c36d9..7c3f89d 100644
--- a/sound/soc/imx/imx-pcm.c
+++ b/sound/soc/imx/imx-pcm.c
@@ -246,21 +246,6 @@ static int imx_get_sdma_transfer(int format, int dai_port, int stream_type)
 	return transfer;
 }
 
-static void audio_stop_dma(struct snd_pcm_substream *substream)
-{
-	struct snd_pcm_runtime *runtime = substream->runtime;
-	struct mxc_runtime_data *prtd = runtime->private_data;
-	unsigned long flags;
-
-	/* stops the dma channel and clears the buffer ptrs */
-	spin_lock_irqsave(&prtd->dma_lock, flags);
-	prtd->active = 0;
-	prtd->period = 0;
-	prtd->periods = 0;
-	mxc_dma_disable(prtd->dma_wchannel);
-	spin_unlock_irqrestore(&prtd->dma_lock, flags);
-}
-
 static int dma_new_period(struct snd_pcm_substream *substream)
 {
 	struct snd_pcm_runtime *runtime = substream->runtime;
@@ -417,33 +402,18 @@ static int imx_pcm_trigger(struct snd_pcm_substream *substream, int cmd)
 
 	switch (cmd) {
 	case SNDRV_PCM_TRIGGER_START:
+	case SNDRV_PCM_TRIGGER_RESUME:
+	case SNDRV_PCM_TRIGGER_PAUSE_RELEASE:
 		prtd->dma_active = 0;
-		/* requested stream startup */
 		prtd->active = 1;
 		ret = dma_new_period(substream);
 		ret = dma_new_period(substream);
 		break;
 	case SNDRV_PCM_TRIGGER_STOP:
-		/* requested stream shutdown */
-		audio_stop_dma(substream);
-		break;
 	case SNDRV_PCM_TRIGGER_SUSPEND:
-		prtd->active = 0;
-		prtd->periods = 0;
-		break;
-	case SNDRV_PCM_TRIGGER_RESUME:
-		prtd->active = 1;
-		prtd->dma_active = 0;
-		ret = dma_new_period(substream);
-		break;
 	case SNDRV_PCM_TRIGGER_PAUSE_PUSH:
 		prtd->active = 0;
 		break;
-	case SNDRV_PCM_TRIGGER_PAUSE_RELEASE:
-		prtd->active = 1;
-		prtd->dma_active = 0;
-		ret = dma_new_period(substream);
-		break;
 	default:
 		ret = -EINVAL;
 		break;
-- 
1.5.4.4

