Patch from http://cygwin.com/ml/gdb-patches/2006-03/msg00176.html. Merged with gdb-6.4 by Richard Titmuss.

2006-03-08   Girish Shilamkar  <girish@linsyssoft.com>

	* arm-linux-tdep.c (arm_linux_supply_gregset): Supply general purpose 
	register set to register cache.
	(arm_linux_supply_fpregset): Supply floating-point register set to 
	register cache.
	(arm_linux_regset_from_core_section): Return the appropriate register 
	set for the core section.
	* config/arm/linux.mt: Add corelow.o.
	* Makefile.in: Add $(regset_h) to dependency list of arm-linux-tdep.o.


diff -Naur gdb-6.4.orig/gdb/arm-linux-tdep.c gdb-6.4/gdb/arm-linux-tdep.c
--- gdb-6.4.orig/gdb/arm-linux-tdep.c	2007-11-06 11:26:09.000000000 +0000
+++ gdb-6.4/gdb/arm-linux-tdep.c	2007-11-06 11:29:46.000000000 +0000
@@ -31,6 +31,7 @@
 #include "doublest.h"
 #include "solib-svr4.h"
 #include "osabi.h"
+#include "regset.h"
 
 #include "arm-tdep.h"
 #include "glibc-tdep.h"
@@ -333,6 +334,81 @@
   return reg_addr;
 }
 
+/* The following enums are used to implement the core file support.  */
+enum {
+  ARM_ELF_NGREG  = 18,      
+  ARM_ELF_NFPREG = 33,
+  ARM_ELF_NVRREG = 33
+};
+
+enum {
+  ARM_ELF_GREGSET_SIZE  = (ARM_ELF_NGREG * 4),
+  ARM_ELF_FPREGSET_SIZE = (ARM_ELF_NFPREG * 12)       
+};
+
+/* Supply register REGNUM from the buffer specified by GREGS and LEN
+   in the general-purpose register set REGSET to register cache
+   REGCACHE.  */
+
+void
+arm_linux_supply_gregset (const struct regset *regset,
+                          struct regcache * regcache,
+                          int regnum, const void *gregs, size_t size)
+{
+  int regi;
+  const bfd_byte *buf = gregs;
+
+  for (regi = 0; regi < 16; regi++)
+    regcache_raw_supply(regcache, regi, buf + 4 * regi);
+
+  regcache_raw_supply (regcache, ARM_FPS_REGNUM, buf + 4 * 16);
+  regcache_raw_supply (regcache, ARM_PS_REGNUM, buf + 4 * 17);
+}
+
+static struct regset arm_linux_gregset = {
+  NULL, 
+  arm_linux_supply_gregset
+};
+
+/* Supply register REGNUM from the buffer specified by FPREGS and LEN
+   in the floating-point register set REGSET to register cache
+   REGCACHE.  */
+
+void
+arm_linux_supply_fpregset (const struct regset *regset,
+                           struct regcache * regcache,
+                           int regnum, const void *fpregs, size_t size)
+{
+  int regi;
+  const bfd_byte *buf = fpregs;
+
+  for (regi = 0; regi < 32; regi++)
+     regcache_raw_supply (regcache, FP0_REGNUM + regi, buf + 8 * regi);
+}
+
+static struct regset arm_linux_fpregset = { 
+  NULL, 
+  arm_linux_supply_fpregset 
+};
+
+/* Return the appropriate register set for the core section identified
+   by SECT_NAME and SECT_SIZE.  */
+
+static const struct regset *
+arm_linux_regset_from_core_section (struct gdbarch *core_arch,
+                                    const char *sect_name, size_t sect_size)
+{
+  struct gdbarch_tdep *tdep = gdbarch_tdep (core_arch);
+
+  if (strcmp (sect_name, ".reg") == 0 && sect_size == ARM_ELF_GREGSET_SIZE)
+    return &arm_linux_gregset;
+  
+  if (strcmp (sect_name, ".reg2") == 0 && sect_size == ARM_ELF_FPREGSET_SIZE)
+    return &arm_linux_fpregset;
+
+  return NULL;
+}
+
 static void
 arm_linux_init_abi (struct gdbarch_info info,
 		    struct gdbarch *gdbarch)
@@ -378,6 +454,10 @@
   /* Enable TLS support.  */
   set_gdbarch_fetch_tls_load_module_address (gdbarch,
                                              svr4_fetch_objfile_link_map);
+
+  set_gdbarch_regset_from_core_section
+    (gdbarch, arm_linux_regset_from_core_section);
+
 }
 
 void
diff -Naur gdb-6.4.orig/gdb/config/arm/linux.mt gdb-6.4/gdb/config/arm/linux.mt
--- gdb-6.4.orig/gdb/config/arm/linux.mt	2007-11-06 11:26:09.000000000 +0000
+++ gdb-6.4/gdb/config/arm/linux.mt	2007-11-06 11:31:14.000000000 +0000
@@ -1,3 +1,4 @@
 # Target: ARM based machine running GNU/Linux
 DEPRECATED_TM_FILE= tm-linux.h
-TDEPFILES= arm-tdep.o arm-linux-tdep.o glibc-tdep.o solib.o solib-svr4.o solib-legacy.o symfile-mem.o
+TDEPFILES= arm-tdep.o arm-linux-tdep.o glibc-tdep.o solib.o solib-svr4.o solib-legacy.o symfile-mem.o corelow.o
+
diff -Naur gdb-6.4.orig/gdb/Makefile.in gdb-6.4/gdb/Makefile.in
--- gdb-6.4.orig/gdb/Makefile.in	2007-11-06 11:26:09.000000000 +0000
+++ gdb-6.4/gdb/Makefile.in	2007-11-06 11:32:06.000000000 +0000
@@ -1739,7 +1739,7 @@
 arm-linux-tdep.o: arm-linux-tdep.c $(defs_h) $(target_h) $(value_h) \
 	$(gdbtypes_h) $(floatformat_h) $(gdbcore_h) $(frame_h) $(regcache_h) \
 	$(doublest_h) $(solib_svr4_h) $(osabi_h) $(arm_tdep_h) \
-	$(glibc_tdep_h)
+	$(glibc_tdep_h) $(regset_h)
 armnbsd-nat.o: armnbsd-nat.c $(defs_h) $(gdbcore_h) $(inferior_h) \
 	$(regcache_h) $(target_h) $(gdb_string_h) $(arm_tdep_h) $(inf_ptrace_h)
 armnbsd-tdep.o: armnbsd-tdep.c $(defs_h) $(osabi_h) $(gdb_string_h) \
