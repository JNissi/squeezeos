#!/bin/sh

/bin/mount -a

echo "Mounting RAM Disk"
/bin/mount -t ramfs ramfs /tmp
/bin/mount -t ramfs ramfs /var
mkdir /var/shm /var/log /var/run /var/core


# enable core files, dumped in /var
echo "/var/core/core-%e" > /proc/sys/kernel/core_pattern
ulimit -c unlimited


echo "Starting syslogd"
/sbin/syslogd

if [ -b /dev/mmcblk0p1 ]; then
	echo "Mounting MMC/SD card (partition 1)"
	mount -t vfat /dev/mmcblk0p1 /mnt/mmc
elif [ -b /dev/mmcblk0 ]; then
	echo "Mounting MMC/SD card (whole device)"
	mount -t vfat /dev/mmcblk0 /mnt/mmc
fi

if ! [ -f /etc/firstboot ]; then
	echo "First boot"
	touch /etc/firstboot

	if [ -x /mnt/mmc/firstboot.sh ]; then
		(cd /mnt/mmc; ./firstboot.sh)
	fi
fi

if ! [ -f /etc/dropbear/dropbear_rsa_host_key ] ; then
    echo "Creating dropbear rsa host key"
    /usr/bin/dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key
fi

if ! [ -f /etc/dropbear/dropbear_dss_host_key ]; then
    echo "Creating dropbear dss host key"
    /usr/bin/dropbearkey -t dss -f /etc/dropbear/dropbear_dss_host_key
fi

echo "Starting lo"
/sbin/ifconfig lo up 127.0.0.1

echo "Starting inetd"
/usr/sbin/inetd


# Start wlan
/etc/init.d/wlan-start


if [ -x /etc/init.d/rcS.local ]; then
	echo "Running rcS.local"
	/etc/init.d/rcS.local
fi

if [ -x /mnt/mmc/jiveboot.sh ]; then
    (cd /mnt/mmc; ./jiveboot.sh)
fi

echo "Starting jive applications"
(cd /usr/bin; /usr/bin/jive &)
